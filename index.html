<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¤œå¸‚æŒ‘æˆ°è³½ï¼šåˆ‡ç†±ç‹—ãƒ»å¹æ°£çƒãƒ»èˆ”æ£’æ£’ç³–</title>
<style>
  :root{
    --brand:#4f7cff;
    --ok:#2bb673;
    --warn:#ffb020;
    --bad:#ff5a5a;
    --ink:#1d2330;
    --bg:#f6f7fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family: system-ui, "Segoe UI", Roboto, "Noto Sans TC", Arial}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  h1{margin:0 0 12px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px;margin:14px 0}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .row>div{flex:1 1 260px}
  button{appearance:none;border:0;border-radius:10px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  button.secondary{background:#e9ecfb;color:#2a3a8c}
  button.ghost{background:#fff;border:2px solid #e5e7f2;color:#2a3a8c}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#eef1ff;color:#3141a6}
  .meter{height:10px;background:#eef0f6;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--warn),var(--bad))}
  .big{font-size:48px;line-height:1}
  .center{text-align:center}
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hud .box{background:#f2f4fb;border:1px solid #e6e9f5;border-radius:10px;padding:8px 10px;font-weight:700}
  .game-stage{min-height:260px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(#ffffff,#f3f6ff)}
  /* ç†±ç‹— */
  .hotdog{display:flex;align-items:center;gap:18px}
  .knife{font-size:64px;transform-origin:top right;transition:.15s}
  .knife.chop{transform:rotate(-35deg) translateY(6px)}
  .dog-track{flex:1;height:14px;background:#ffe7c7;border-radius:999px;position:relative;overflow:hidden;border:2px solid #f0c899}
  .dog-fill{position:absolute;left:0;top:0;height:100%;width:0%;background:#d66b2d}
  /* æ°£çƒ */
  .balloon-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .balloon{width:90px;height:120px;background:#ff6b81;border-radius:55% 55% 60% 60% / 60% 60% 40% 40%;position:relative;transition:.12s}
  .balloon:after{content:"";position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);border-left:10px solid transparent;border-right:10px solid transparent;border-top:18px solid #ff6b81}
  .string{width:2px;height:80px;background:#aaa;margin-top:-6px}
  /* æ£’æ£’ç³– */
  .lolli-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .lolli{width:110px;height:110px;border-radius:50%;background:conic-gradient(#ff7eb3 0 25%, #ffd36b 0 50%, #7ee5da 0 75%, #9d8bff 0);box-shadow: inset 0 0 0 8px #fff, 0 8px 16px rgba(0,0,0,.12)}
  .stick{width:12px;height:120px;background:#fff;border-radius:6px}
  /* footer tips */
  .tiny{font-size:12px;opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <h1>å¤œå¸‚æŒ‘æˆ°è³½ ğŸª</h1>
  <div class="card">
    <div class="row">
      <div>
        <div class="hud">
          <div class="box">é—œå¡ï¼š<span id="stageName">â€”</span></div>
          <div class="box">åˆ†æ•¸ï¼š<span id="score">0</span></div>
          <div class="box">æ™‚é–“ï¼š<span id="time">00:00</span></div>
          <div class="box">éº¥å…‹é¢¨ï¼š<span id="micState" class="pill">æœªå•Ÿç”¨</span></div>
        </div>
        <div style="height:12px"></div>
        <div class="meter"><div class="bar" id="lvlBar"></div></div>
        <div class="tiny">ç›®å‰éŸ³é‡ï¼š<span id="levelTxt">0</span>ï¼ˆå¯èª¿éˆæ•åº¦ï¼‰</div>
      </div>
      <div>
        <label>éˆæ•åº¦ï¼ˆè¶Šå°è¶Šæ•æ„Ÿï¼‰<br>
          <input id="sens" type="range" min="0.001" max="0.02" step="0.001" value="0.006">
        </label>
        <br>
        <label>è§¸ç™¼å†·å»ï¼ˆæ¯«ç§’ï¼‰<br>
          <input id="cooldown" type="range" min="150" max="1200" step="50" value="350">
        </label>
        <div style="height:8px"></div>
        <button id="btnMic">å…è¨±éº¥å…‹é¢¨</button>
        <button id="btnStart" class="secondary" disabled>é–‹å§‹æŒ‘æˆ°</button>
        <button id="btnReset" class="ghost" disabled>é‡æ–°é–‹å§‹</button>
      </div>
    </div>
  </div>

  <div class="card game-stage" id="stage">
    <div class="center">
      <div class="big">ğŸ®</div>
      <p>é»ã€Œå…è¨±éº¥å…‹é¢¨ã€â†’ã€Œé–‹å§‹æŒ‘æˆ°ã€<br>ä¾åºæŒ‘æˆ°ï¼šåˆ‡ç†±ç‹— â†’ å¹æ°£çƒ â†’ èˆ”æ£’æ£’ç³–</p>
    </div>
  </div>

  <div class="card">
    <b>æ“ä½œæç¤º</b>
    <ul>
      <li>åˆ‡ç†±ç‹—ï¼šç™¼å‡ºçŸ­ä¿ƒã€Œå“ˆï¼å•Šã€çš„æœ‰è²æ°£æµï¼ˆçˆ†ç™¼éŸ³é‡ï¼‰ï¼åˆ‡ä¸€ä¸‹ã€‚</li>
      <li>å¹æ°£çƒï¼šæŒçºŒã€Œå‘¼â€”ã€çš„é¢¨è²ï¼ˆç©©å®šéŸ³é‡ï¼‰ï¼æ…¢æ…¢è†¨è„¹ï¼Œç›´åˆ°çˆ†ï¼</li>
      <li>èˆ”æ£’æ£’ç³–ï¼šå¿«é€Ÿã€å°å¹…åº¦çš„ã€Œå•µã€å•µã€è²ï¼ˆé€£çºŒå°å³°å€¼ï¼‰ï¼èˆ”ä¸€ä¸‹ã€‚</li>
    </ul>
    <div class="tiny">ç¾å ´å˜ˆé›œæ™‚æŠŠã€Œéˆæ•åº¦ã€æ‹‰åˆ°è¼ƒå°å€¼ï¼ˆæ›´æ•æ„Ÿï¼‰ï¼Œæˆ–æŠŠå°æœ‹å‹é è¿‘éº¥å…‹é¢¨ã€‚</div>
  </div>
</div>

<script>
/* =========================
   éŸ³é‡åµæ¸¬ï¼ˆWebAudioï¼‰
   ========================= */
let audioCtx, analyser, micStream;
const levelTxt = document.getElementById('levelTxt');
const lvlBar = document.getElementById('lvlBar');
const micState = document.getElementById('micState');
const btnMic = document.getElementById('btnMic');
const btnStart = document.getElementById('btnStart');
const btnReset = document.getElementById('btnReset');
const sensEl = document.getElementById('sens');
const cooldownEl = document.getElementById('cooldown');

let currentLevel = 0; // 0~1
let lastTriggerAt = 0;

async function initMic(){
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024; // è¶Šå¤§è¶Šå¹³æ»‘
    src.connect(analyser);
    micState.textContent = 'å·²å•Ÿç”¨';
    micState.style.background = '#e6f7ec';
    micState.style.color = '#148a4b';
    btnStart.disabled = false;
    monitorLevel();
  }catch(e){
    alert('éœ€è¦éº¥å…‹é¢¨æ¬Šé™æ‰èƒ½éŠæˆ²å–”ï¼\n' + e.message);
  }
}

function monitorLevel(){
  const buf = new Uint8Array(analyser.frequencyBinCount);
  function loop(){
    analyser.getByteTimeDomainData(buf);
    // è¨ˆç®— RMSï¼ˆè¿‘ä¼¼éŸ³é‡ï¼‰
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const v = (buf[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum / buf.length); // 0~1
    currentLevel = rms; 
    levelTxt.textContent = currentLevel.toFixed(3);
    lvlBar.style.width = Math.min(100, Math.round(currentLevel*200)) + '%';
    requestAnimationFrame(loop);
  }
  loop();
}

btnMic.onclick = initMic;

/* =========================
   éŠæˆ²ç‹€æ…‹æ©Ÿ
   ========================= */
const stageHost = document.getElementById('stage');
const stageName = document.getElementById('stageName');
const scoreEl = document.getElementById('score');
const timeEl = document.getElementById('time');

let score = 0;
let timerId = 0;
let timeLeft = 30; // æ¯é—œé è¨­ 30 ç§’
let stageIndex = -1; // 0:ç†±ç‹— 1:æ°£çƒ 2:æ£’æ£’ç³–
let playing = false;

function setTimer(sec){
  clearInterval(timerId);
  timeLeft = sec;
  timeEl.textContent = fmt(timeLeft);
  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = fmt(timeLeft);
    if(timeLeft<=0){
      clearInterval(timerId);
      endStage(false); // æ™‚é–“åˆ°æœªéé—œ
    }
  },1000);
}
function fmt(s){
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return `${m}:${ss}`;
}

btnStart.onclick = ()=>{
  if(!analyser){ alert('è«‹å…ˆå…è¨±éº¥å…‹é¢¨'); return; }
  btnStart.disabled = true;
  btnReset.disabled = false;
  score = 0;
  scoreEl.textContent = score;
  stageIndex = -1;
  playing = true;
  nextStage();
};
btnReset.onclick = ()=>{
  location.reload();
};

function nextStage(){
  stageIndex++;
  if(stageIndex===0) loadHotdog();
  else if(stageIndex===1) loadBalloon();
  else if(stageIndex===2) loadLollipop();
  else finishAll();
}

/* =========================
   é—œå¡ 1ï¼šåˆ‡ç†±ç‹—
   æ¢ä»¶ï¼šè§¸ç™¼ N æ¬¡çˆ†ç™¼å³°å€¼
   ========================= */
function loadHotdog(){
  stageName.textContent = 'åˆ‡ç†±ç‹—';
  stageHost.innerHTML = `
    <div class="hotdog">
      <div class="knife" id="knife">ğŸ”ª</div>
      <div class="dog-track"><div class="dog-fill" id="dogFill"></div></div>
    </div>
    <div style="position:absolute;right:12px;bottom:12px" class="pill">éœ€è¦ 6 ä¸‹</div>
  `;
  const need = 6;
  let done = 0;
  setTimer(25);
  let cutting = false;

  const knife = document.getElementById('knife');
  const dogFill = document.getElementById('dogFill');

  function onAudio(){
    if(!playing || stageIndex!==0) return;
    const sens = parseFloat(sensEl.value);
    const cd = parseInt(cooldownEl.value,10);
    const now = performance.now();

    // çˆ†ç™¼å³°å€¼ï¼šç¬é–“è¶…éé–€æª»æ‰ç®—ä¸€æ¬¡
    if(currentLevel > sens*2.0 && (now - lastTriggerAt) > cd){
      lastTriggerAt = now;
      if(!cutting){
        cutting = true;
        knife.classList.add('chop');
        setTimeout(()=>knife.classList.remove('chop'),120);
      }
      done++;
      const pct = Math.min(100, Math.round(done/need*100));
      dogFill.style.width = pct + '%';
      score += 10;
      scoreEl.textContent = score;
      if(done>=need){
        endStage(true);
      }
    }
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   é—œå¡ 2ï¼šå¹æ°£çƒ
   æ¢ä»¶ï¼šæŒçºŒéŸ³é‡è®“ size é”åˆ° 1.8 å€å³çˆ†
   ========================= */
function loadBalloon(){
  stageName.textContent = 'å¹æ°£çƒ';
  stageHost.innerHTML = `
    <div class="balloon-wrap">
      <div class="balloon" id="balloon"></div>
      <div class="string"></div>
      <div class="tiny">æŒçºŒå¹æ°£è®“æ°£çƒè®Šå¤§</div>
    </div>
  `;
  setTimer(25);
  const balloon = document.getElementById('balloon');
  let size = 1.0; // scale
  let progress = 0; // 0~100 é¡¯ç¤ºåœ¨æ¢ä¸Š
  function onAudio(){
    if(!playing || stageIndex!==1) return;
    const sens = parseFloat(sensEl.value);
    // é€£çºŒéŸ³é‡ï¼šé«˜æ–¼ sens çš„é‡è½‰æˆæˆé•·ï¼Œä½æ–¼å‰‡ç·©æ…¢å›å½ˆ
    if(currentLevel > sens){
      const gain = (currentLevel - sens) * 0.25; // æˆé•·é€Ÿåº¦
      size += gain;
      progress = Math.min(100, progress + gain*28);
    }else{
      size -= 0.005; // å›ç¸®
      progress = Math.max(0, progress - 0.8);
    }
    size = Math.max(1.0, Math.min(1.9, size));
    balloon.style.transform = `scale(${size})`;
    lvlBar.style.width = Math.round(progress) + '%';

    if(size >= 1.8){
      // çˆ†ï¼
      balloon.style.transition = 'transform .08s';
      balloon.style.transform = 'scale(2.2)';
      setTimeout(()=>{ endStage(true); }, 80);
      score += 30;
      scoreEl.textContent = score;
      return;
    }
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   é—œå¡ 3ï¼šèˆ”æ£’æ£’ç³–
   æ¢ä»¶ï¼šåµæ¸¬ã€Œå¿«é€Ÿå°å³°å€¼ã€é” N æ¬¡
   ========================= */
function loadLollipop(){
  stageName.textContent = 'èˆ”æ£’æ£’ç³–';
  stageHost.innerHTML = `
    <div class="lolli-wrap">
      <div class="lolli" id="lolli"></div>
      <div class="stick"></div>
      <div class="tiny">é€£çºŒã€Œå•µå•µå•µã€å¿«ç¯€å¥å°è²éŸ³</div>
    </div>
    <div style="position:absolute;right:12px;bottom:12px" class="pill">éœ€è¦ 12 æ¬¡</div>
  `;
  setTimer(25);
  const lolli = document.getElementById('lolli');

  const need = 12;
  let hits = 0;
  let recent = []; // æœ€è¿‘ 500ms çš„å³°å€¼ç´€éŒ„
  function onAudio(){
    if(!playing || stageIndex!==2) return;
    const sens = parseFloat(sensEl.value);
    const cd = parseInt(cooldownEl.value,10);
    const now = performance.now();

    // å°å³°å€¼ï¼šç•¥é«˜æ–¼ sens ä½†ä¸è¦å¤ªå¤§ï¼ˆé¿å…è®Šæˆç†±ç‹—çš„çˆ†ç™¼éŸ³ï¼‰
    const smallPeak = (currentLevel > sens*1.1 && currentLevel < sens*2.0);
    if(smallPeak && (now - lastTriggerAt) > (cd*0.6)){
      lastTriggerAt = now;
      recent.push(now);
      hits++;
      // è¦–è¦ºå°æŠ–å‹•
      const r = 1 + Math.random()*0.08;
      lolli.style.transform = `scale(${r}) rotate(${(Math.random()*6-3)}deg)`;
      setTimeout(()=>{ lolli.style.transform = 'none'; }, 80);

      score += 5;
      scoreEl.textContent = score;
      // é€²åº¦æ¢å€Ÿç”¨é¡¯ç¤º
      const pct = Math.min(100, Math.round(hits/need*100));
      lvlBar.style.width = pct + '%';

      if(hits>=need){
        endStage(true);
        return;
      }
    }
    // æ¸…ç†éèˆŠçš„è¨˜éŒ„ï¼ˆä¸æ˜¯å¿…éœ€ï¼Œä½†å¯åšç¯€å¥çµ±è¨ˆï¼‰
    recent = recent.filter(t => now - t < 600);
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   é—œå¡çµæŸ / å…¨éƒ¨å®Œæˆ
   ========================= */
function endStage(passed){
  playing = false;
  clearInterval(timerId);
  const title = ['åˆ‡ç†±ç‹—','å¹æ°£çƒ','èˆ”æ£’æ£’ç³–'][stageIndex] || 'é—œå¡';
  stageHost.innerHTML = `
    <div class="center">
      <div class="big">${passed ? 'ğŸ‰' : 'â±ï¸'}</div>
      <h2>${title} ${passed ? 'å®Œæˆï¼' : 'æ™‚é–“åˆ°'}</h2>
      <p>ç›®å‰åˆ†æ•¸ï¼š<b>${score}</b></p>
      <button id="btnNext">${stageIndex<2 ? 'ä¸‹ä¸€é—œ' : 'çœ‹çµç®—'}</button>
    </div>
  `;
  document.getElementById('btnNext').onclick = ()=>{
    playing = true;
    if(stageIndex<2) nextStage();
    else finishAll();
  };
}

function finishAll(){
  stageName.textContent = 'çµç®—';
  stageHost.innerHTML = `
    <div class="center">
      <div class="big">ğŸ</div>
      <h2>æŒ‘æˆ°å®Œæˆï¼ç¸½åˆ†ï¼š${score}</h2>
      <p>å†èª¿æ•´ã€Œéˆæ•åº¦ã€èˆ‡ã€Œå†·å»ã€å¯ä»¥è®“é—œå¡æ›´ç¬¦åˆå­©å­ç¾å ´éŸ³é‡ã€‚</p>
      <button class="secondary" id="again">å†ç©ä¸€æ¬¡</button>
    </div>
  `;
  document.getElementById('again').onclick = ()=>location.reload();
}
</script>
</body>
</html>

