<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>夜市挑戰賽：切熱狗・吹氣球・舔棒棒糖</title>
<style>
  :root{
    --brand:#4f7cff;
    --ok:#2bb673;
    --warn:#ffb020;
    --bad:#ff5a5a;
    --ink:#1d2330;
    --bg:#f6f7fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family: system-ui, "Segoe UI", Roboto, "Noto Sans TC", Arial}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  h1{margin:0 0 12px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px;margin:14px 0}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .row>div{flex:1 1 260px}
  button{appearance:none;border:0;border-radius:10px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  button.secondary{background:#e9ecfb;color:#2a3a8c}
  button.ghost{background:#fff;border:2px solid #e5e7f2;color:#2a3a8c}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#eef1ff;color:#3141a6}
  .meter{height:10px;background:#eef0f6;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--warn),var(--bad))}
  .big{font-size:48px;line-height:1}
  .center{text-align:center}
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hud .box{background:#f2f4fb;border:1px solid #e6e9f5;border-radius:10px;padding:8px 10px;font-weight:700}
  .game-stage{min-height:260px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(#ffffff,#f3f6ff)}
  /* 熱狗 */
  .hotdog{display:flex;align-items:center;gap:18px}
  .knife{font-size:64px;transform-origin:top right;transition:.15s}
  .knife.chop{transform:rotate(-35deg) translateY(6px)}
  .dog-track{flex:1;height:14px;background:#ffe7c7;border-radius:999px;position:relative;overflow:hidden;border:2px solid #f0c899}
  .dog-fill{position:absolute;left:0;top:0;height:100%;width:0%;background:#d66b2d}
  /* 氣球 */
  .balloon-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .balloon{width:90px;height:120px;background:#ff6b81;border-radius:55% 55% 60% 60% / 60% 60% 40% 40%;position:relative;transition:.12s}
  .balloon:after{content:"";position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);border-left:10px solid transparent;border-right:10px solid transparent;border-top:18px solid #ff6b81}
  .string{width:2px;height:80px;background:#aaa;margin-top:-6px}
  /* 棒棒糖 */
  .lolli-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .lolli{width:110px;height:110px;border-radius:50%;background:conic-gradient(#ff7eb3 0 25%, #ffd36b 0 50%, #7ee5da 0 75%, #9d8bff 0);box-shadow: inset 0 0 0 8px #fff, 0 8px 16px rgba(0,0,0,.12)}
  .stick{width:12px;height:120px;background:#fff;border-radius:6px}
  /* footer tips */
  .tiny{font-size:12px;opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <h1>夜市挑戰賽 🎪</h1>
  <div class="card">
    <div class="row">
      <div>
        <div class="hud">
          <div class="box">關卡：<span id="stageName">—</span></div>
          <div class="box">分數：<span id="score">0</span></div>
          <div class="box">時間：<span id="time">00:00</span></div>
          <div class="box">麥克風：<span id="micState" class="pill">未啟用</span></div>
        </div>
        <div style="height:12px"></div>
        <div class="meter"><div class="bar" id="lvlBar"></div></div>
        <div class="tiny">目前音量：<span id="levelTxt">0</span>（可調靈敏度）</div>
      </div>
      <div>
        <label>靈敏度（越小越敏感）<br>
          <input id="sens" type="range" min="0.001" max="0.02" step="0.001" value="0.006">
        </label>
        <br>
        <label>觸發冷卻（毫秒）<br>
          <input id="cooldown" type="range" min="150" max="1200" step="50" value="350">
        </label>
        <div style="height:8px"></div>
        <button id="btnMic">允許麥克風</button>
        <button id="btnStart" class="secondary" disabled>開始挑戰</button>
        <button id="btnReset" class="ghost" disabled>重新開始</button>
      </div>
    </div>
  </div>

  <div class="card game-stage" id="stage">
    <div class="center">
      <div class="big">🎮</div>
      <p>點「允許麥克風」→「開始挑戰」<br>依序挑戰：切熱狗 → 吹氣球 → 舔棒棒糖</p>
    </div>
  </div>

  <div class="card">
    <b>操作提示</b>
    <ul>
      <li>切熱狗：發出短促「哈／啊」的有聲氣流（爆發音量）＝切一下。</li>
      <li>吹氣球：持續「呼—」的風聲（穩定音量）＝慢慢膨脹，直到爆！</li>
      <li>舔棒棒糖：快速、小幅度的「啵、啵」聲（連續小峰值）＝舔一下。</li>
    </ul>
    <div class="tiny">現場嘈雜時把「靈敏度」拉到較小值（更敏感），或把小朋友靠近麥克風。</div>
  </div>
</div>

<script>
/* =========================
   音量偵測（WebAudio）
   ========================= */
let audioCtx, analyser, micStream;
const levelTxt = document.getElementById('levelTxt');
const lvlBar = document.getElementById('lvlBar');
const micState = document.getElementById('micState');
const btnMic = document.getElementById('btnMic');
const btnStart = document.getElementById('btnStart');
const btnReset = document.getElementById('btnReset');
const sensEl = document.getElementById('sens');
const cooldownEl = document.getElementById('cooldown');

let currentLevel = 0; // 0~1
let lastTriggerAt = 0;

async function initMic(){
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024; // 越大越平滑
    src.connect(analyser);
    micState.textContent = '已啟用';
    micState.style.background = '#e6f7ec';
    micState.style.color = '#148a4b';
    btnStart.disabled = false;
    monitorLevel();
  }catch(e){
    alert('需要麥克風權限才能遊戲喔！\n' + e.message);
  }
}

function monitorLevel(){
  const buf = new Uint8Array(analyser.frequencyBinCount);
  function loop(){
    analyser.getByteTimeDomainData(buf);
    // 計算 RMS（近似音量）
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const v = (buf[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum / buf.length); // 0~1
    currentLevel = rms; 
    levelTxt.textContent = currentLevel.toFixed(3);
    lvlBar.style.width = Math.min(100, Math.round(currentLevel*200)) + '%';
    requestAnimationFrame(loop);
  }
  loop();
}

btnMic.onclick = initMic;

/* =========================
   遊戲狀態機
   ========================= */
const stageHost = document.getElementById('stage');
const stageName = document.getElementById('stageName');
const scoreEl = document.getElementById('score');
const timeEl = document.getElementById('time');

let score = 0;
let timerId = 0;
let timeLeft = 30; // 每關預設 30 秒
let stageIndex = -1; // 0:熱狗 1:氣球 2:棒棒糖
let playing = false;

function setTimer(sec){
  clearInterval(timerId);
  timeLeft = sec;
  timeEl.textContent = fmt(timeLeft);
  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = fmt(timeLeft);
    if(timeLeft<=0){
      clearInterval(timerId);
      endStage(false); // 時間到未過關
    }
  },1000);
}
function fmt(s){
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return `${m}:${ss}`;
}

btnStart.onclick = ()=>{
  if(!analyser){ alert('請先允許麥克風'); return; }
  btnStart.disabled = true;
  btnReset.disabled = false;
  score = 0;
  scoreEl.textContent = score;
  stageIndex = -1;
  playing = true;
  nextStage();
};
btnReset.onclick = ()=>{
  location.reload();
};

function nextStage(){
  stageIndex++;
  if(stageIndex===0) loadHotdog();
  else if(stageIndex===1) loadBalloon();
  else if(stageIndex===2) loadLollipop();
  else finishAll();
}

/* =========================
   關卡 1：切熱狗
   條件：觸發 N 次爆發峰值
   ========================= */
function loadHotdog(){
  stageName.textContent = '切熱狗';
  stageHost.innerHTML = `
    <div class="hotdog">
      <div class="knife" id="knife">🔪</div>
      <div class="dog-track"><div class="dog-fill" id="dogFill"></div></div>
    </div>
    <div style="position:absolute;right:12px;bottom:12px" class="pill">需要 6 下</div>
  `;
  const need = 6;
  let done = 0;
  setTimer(25);
  let cutting = false;

  const knife = document.getElementById('knife');
  const dogFill = document.getElementById('dogFill');

  function onAudio(){
    if(!playing || stageIndex!==0) return;
    const sens = parseFloat(sensEl.value);
    const cd = parseInt(cooldownEl.value,10);
    const now = performance.now();

    // 爆發峰值：瞬間超過門檻才算一次
    if(currentLevel > sens*2.0 && (now - lastTriggerAt) > cd){
      lastTriggerAt = now;
      if(!cutting){
        cutting = true;
        knife.classList.add('chop');
        setTimeout(()=>knife.classList.remove('chop'),120);
      }
      done++;
      const pct = Math.min(100, Math.round(done/need*100));
      dogFill.style.width = pct + '%';
      score += 10;
      scoreEl.textContent = score;
      if(done>=need){
        endStage(true);
      }
    }
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   關卡 2：吹氣球
   條件：持續音量讓 size 達到 1.8 倍即爆
   ========================= */
function loadBalloon(){
  stageName.textContent = '吹氣球';
  stageHost.innerHTML = `
    <div class="balloon-wrap">
      <div class="balloon" id="balloon"></div>
      <div class="string"></div>
      <div class="tiny">持續吹氣讓氣球變大</div>
    </div>
  `;
  setTimer(25);
  const balloon = document.getElementById('balloon');
  let size = 1.0; // scale
  let progress = 0; // 0~100 顯示在條上
  function onAudio(){
    if(!playing || stageIndex!==1) return;
    const sens = parseFloat(sensEl.value);
    // 連續音量：高於 sens 的量轉成成長，低於則緩慢回彈
    if(currentLevel > sens){
      const gain = (currentLevel - sens) * 0.25; // 成長速度
      size += gain;
      progress = Math.min(100, progress + gain*28);
    }else{
      size -= 0.005; // 回縮
      progress = Math.max(0, progress - 0.8);
    }
    size = Math.max(1.0, Math.min(1.9, size));
    balloon.style.transform = `scale(${size})`;
    lvlBar.style.width = Math.round(progress) + '%';

    if(size >= 1.8){
      // 爆！
      balloon.style.transition = 'transform .08s';
      balloon.style.transform = 'scale(2.2)';
      setTimeout(()=>{ endStage(true); }, 80);
      score += 30;
      scoreEl.textContent = score;
      return;
    }
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   關卡 3：舔棒棒糖
   條件：偵測「快速小峰值」達 N 次
   ========================= */
function loadLollipop(){
  stageName.textContent = '舔棒棒糖';
  stageHost.innerHTML = `
    <div class="lolli-wrap">
      <div class="lolli" id="lolli"></div>
      <div class="stick"></div>
      <div class="tiny">連續「啵啵啵」快節奏小聲音</div>
    </div>
    <div style="position:absolute;right:12px;bottom:12px" class="pill">需要 12 次</div>
  `;
  setTimer(25);
  const lolli = document.getElementById('lolli');

  const need = 12;
  let hits = 0;
  let recent = []; // 最近 500ms 的峰值紀錄
  function onAudio(){
    if(!playing || stageIndex!==2) return;
    const sens = parseFloat(sensEl.value);
    const cd = parseInt(cooldownEl.value,10);
    const now = performance.now();

    // 小峰值：略高於 sens 但不要太大（避免變成熱狗的爆發音）
    const smallPeak = (currentLevel > sens*1.1 && currentLevel < sens*2.0);
    if(smallPeak && (now - lastTriggerAt) > (cd*0.6)){
      lastTriggerAt = now;
      recent.push(now);
      hits++;
      // 視覺小抖動
      const r = 1 + Math.random()*0.08;
      lolli.style.transform = `scale(${r}) rotate(${(Math.random()*6-3)}deg)`;
      setTimeout(()=>{ lolli.style.transform = 'none'; }, 80);

      score += 5;
      scoreEl.textContent = score;
      // 進度條借用顯示
      const pct = Math.min(100, Math.round(hits/need*100));
      lvlBar.style.width = pct + '%';

      if(hits>=need){
        endStage(true);
        return;
      }
    }
    // 清理過舊的記錄（不是必需，但可做節奏統計）
    recent = recent.filter(t => now - t < 600);
    requestAnimationFrame(onAudio);
  }
  onAudio();
}

/* =========================
   關卡結束 / 全部完成
   ========================= */
function endStage(passed){
  playing = false;
  clearInterval(timerId);
  const title = ['切熱狗','吹氣球','舔棒棒糖'][stageIndex] || '關卡';
  stageHost.innerHTML = `
    <div class="center">
      <div class="big">${passed ? '🎉' : '⏱️'}</div>
      <h2>${title} ${passed ? '完成！' : '時間到'}</h2>
      <p>目前分數：<b>${score}</b></p>
      <button id="btnNext">${stageIndex<2 ? '下一關' : '看結算'}</button>
    </div>
  `;
  document.getElementById('btnNext').onclick = ()=>{
    playing = true;
    if(stageIndex<2) nextStage();
    else finishAll();
  };
}

function finishAll(){
  stageName.textContent = '結算';
  stageHost.innerHTML = `
    <div class="center">
      <div class="big">🏁</div>
      <h2>挑戰完成！總分：${score}</h2>
      <p>再調整「靈敏度」與「冷卻」可以讓關卡更符合孩子現場音量。</p>
      <button class="secondary" id="again">再玩一次</button>
    </div>
  `;
  document.getElementById('again').onclick = ()=>location.reload();
}
</script>
</body>
</html>

